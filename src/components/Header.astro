---
import Search from './Search.astro';
import { base } from '../utils/paths';

const currentPath = Astro.url.pathname;

const primaryLinks = [
  { label: 'Work', href: `${base}#work` },
  { label: 'Philosophy', href: `${base}philosophy/` },
  { label: 'About', href: `${base}about/` },
  { label: 'Resume', href: `${base}resume/` },
];

const moreLinks = [
  { label: 'Gallery', href: `${base}gallery/` },
  { label: 'Essays', href: `${base}essays/` },
  { label: 'Dashboard', href: `${base}dashboard/` },
  { label: 'Omega', href: `${base}omega/` },
  { label: 'Architecture', href: `${base}architecture/` },
  { label: 'Products', href: `${base}products/` },
  { label: 'GitHub Pages', href: `${base}github-pages/` },
  { label: 'Community', href: `${base}community/` },
  { label: 'Consult', href: `${base}consult/` },
];

const connectLinks = [
  { label: 'Contact', href: 'mailto:padavano.anthony@gmail.com' },
  { label: 'LinkedIn', href: 'https://www.linkedin.com/in/anthony-james-padavano-98a40a186/', external: true },
  { label: 'GitHub', href: 'https://github.com/4444j99', external: true },
];
---

<header class="header">
  <div class="container header__inner">
    <a href={base} class="header__logo">
      <span class="header__name">4444j99</span>
    </a>
    <button
      class="header__toggle"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="main-nav"
    >
      <span class="header__toggle-bar"></span>
      <span class="header__toggle-bar"></span>
      <span class="header__toggle-bar"></span>
    </button>
    <nav class="header__nav" id="main-nav" aria-label="Main navigation">
      {primaryLinks.map(item => (
        <a
          href={item.href}
          class:list={['header__link', { 'header__link--active': currentPath === item.href }]}
        >
          {item.label}
        </a>
      ))}

      {/* Desktop dropdown */}
      <div class="header__dropdown">
        <button
          class="header__link header__dropdown-trigger"
          aria-expanded="false"
          aria-haspopup="menu"
        >
          More
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 5l3 3 3-3"/>
          </svg>
        </button>
        <div class="header__dropdown-menu" role="menu">
          {moreLinks.map(item => (
            <a href={item.href} role="menuitem">{item.label}</a>
          ))}
          <hr />
          {connectLinks.map(item => (
            <a
              href={item.href}
              role="menuitem"
              {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
            >
              {item.label}{item.external && <span class="header__external" aria-hidden="true"> ↗</span>}
            </a>
          ))}
        </div>
      </div>

      {/* Mobile-only extra links (hidden on desktop) */}
      {moreLinks.map(item => (
        <a
          href={item.href}
          class:list={['header__link header__link--mobile', { 'header__link--active': currentPath === item.href }]}
        >
          {item.label}
        </a>
      ))}
      <hr class="header__sep--mobile" />
      {connectLinks.map(item => (
        <a
          href={item.href}
          class="header__link header__link--mobile"
          {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
        >
          {item.label}{item.external && <span class="header__external" aria-hidden="true"> ↗</span>}
        </a>
      ))}

      <Search />
      <button class="theme-toggle" aria-label="Toggle light/dark theme" title="Toggle theme">
        <svg class="theme-icon theme-icon--sun" width="16" height="16" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="9" cy="9" r="4"/>
          <path d="M9 1v2M9 15v2M1 9h2M15 9h2M3.3 3.3l1.4 1.4M13.3 13.3l1.4 1.4M3.3 14.7l1.4-1.4M13.3 4.7l1.4-1.4"/>
        </svg>
        <svg class="theme-icon theme-icon--moon" width="16" height="16" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M15.1 9.9A6 6 0 1 1 8.1 2.9a7 7 0 0 0 7 7z"/>
        </svg>
      </button>
    </nav>
  </div>
</header>

<script>
  interface HeaderState {
    controller?: AbortController;
  }

  function getHeaderState(): HeaderState {
    const w = window as Window & { __headerState?: HeaderState };
    if (!w.__headerState) w.__headerState = {};
    return w.__headerState;
  }

  function initHeader() {
    const state = getHeaderState();
    state.controller?.abort();
    const controller = new AbortController();
    const { signal } = controller;
    state.controller = controller;

    // --- Mobile menu: toggle, focus trap, scroll lock ---
    const headerEl = document.querySelector('.header') as HTMLElement | null;
    const toggleBtn = document.querySelector('.header__toggle') as HTMLButtonElement | null;
    const nav = document.querySelector('.header__nav') as HTMLElement | null;
    if (!headerEl || !toggleBtn || !nav) return;

    // Reset menu state after navigation
    headerEl.classList.remove('header--open');
    toggleBtn.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';

    function openMenu() {
      toggleBtn!.setAttribute('aria-expanded', 'true');
      headerEl!.classList.add('header--open');
      document.body.style.overflow = 'hidden';
      const ddMenu = document.querySelector('.header__dropdown-menu');
      const ddTrigger = document.querySelector('.header__dropdown-trigger');
      if (ddMenu) ddMenu.removeAttribute('data-open');
      if (ddTrigger) ddTrigger.setAttribute('aria-expanded', 'false');
    }

    function closeMenu() {
      toggleBtn!.setAttribute('aria-expanded', 'false');
      headerEl!.classList.remove('header--open');
      document.body.style.overflow = '';
      toggleBtn!.focus();
    }

    toggleBtn.addEventListener('click', () => {
      const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
      if (isOpen) closeMenu(); else openMenu();
    }, { signal });

    nav.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if (headerEl!.classList.contains('header--open')) closeMenu();
      }, { signal });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && headerEl!.classList.contains('header--open')) {
        closeMenu();
      }
    }, { signal });

    nav.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab' || !headerEl!.classList.contains('header--open')) return;
      const focusable = nav!.querySelectorAll<HTMLElement>('a, button, [tabindex]:not([tabindex="-1"])');
      if (focusable.length === 0) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }, { signal });

    // --- Dropdown toggle ---
    const trigger = document.querySelector('.header__dropdown-trigger') as HTMLButtonElement | null;
    const menu = document.querySelector('.header__dropdown-menu') as HTMLElement | null;
    if (!trigger || !menu) return;

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = menu.hasAttribute('data-open');
      if (isOpen) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      } else {
        menu.setAttribute('data-open', '');
        trigger.setAttribute('aria-expanded', 'true');
        const items = menu.querySelectorAll<HTMLElement>('[role="menuitem"]');
        if (items.length) items[0].focus();
      }
    }, { signal });

    menu.addEventListener('keydown', (e) => {
      const items = [...menu.querySelectorAll<HTMLElement>('[role="menuitem"]')];
      const idx = items.indexOf(document.activeElement as HTMLElement);
      if (e.key === 'ArrowDown') { e.preventDefault(); items[(idx + 1) % items.length].focus(); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); items[(idx - 1 + items.length) % items.length].focus(); }
      else if (e.key === 'Home') { e.preventDefault(); items[0].focus(); }
      else if (e.key === 'End') { e.preventDefault(); items[items.length - 1].focus(); }
    }, { signal });

    document.addEventListener('click', (e) => {
      if (!menu.hasAttribute('data-open')) return;
      if (!menu.contains(e.target as Node) && e.target !== trigger) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    }, { signal });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && menu.hasAttribute('data-open')) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
        trigger.focus();
      }
    }, { signal });

    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      }, { signal });
    });

    document.addEventListener('astro:before-swap', () => {
      controller.abort();
    }, { once: true, signal });
  }

  document.addEventListener('astro:page-load', initHeader);
</script>

<style>
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-chrome);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 0 rgba(var(--spectrum-current, 212, 168, 83), 0.6);
    transition: box-shadow 0.8s ease;
  }

  .header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .header__logo {
    text-decoration: none;
    padding: 0.5rem 0;
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  .header__name {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-primary);
    letter-spacing: -0.01em;
  }

  /* --- Nav --- */
  .header__nav {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
  }

  .header__link {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
    padding: 0.5rem 0.25rem;
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  .header__link:hover,
  .header__link--active {
    color: var(--text-primary);
  }

  /* --- Dropdown --- */
  .header__dropdown {
    position: relative;
  }

  .header__dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .header__dropdown-trigger svg {
    transition: transform var(--transition-fast);
  }

  .header__dropdown-trigger[aria-expanded="true"] svg {
    transform: rotate(180deg);
  }

  .header__dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 180px;
    background: var(--bg-card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: var(--space-xs) 0;
    z-index: 500;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
    transition: background var(--transition-normal), box-shadow var(--transition-normal);
  }

  :global(html[data-theme="light"]) .header__dropdown-menu {
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 0.9);
  }

  .header__dropdown-menu:hover,
  .header__dropdown-menu:focus-within {
    background: var(--bg-card);
    opacity: 0.98;
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5);
  }

  :global(html[data-theme="light"]) .header__dropdown-menu:hover,
  :global(html[data-theme="light"]) .header__dropdown-menu:focus-within {
    background: #ffffff;
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
  }

  .header__dropdown-menu[data-open] {
    display: flex;
    flex-direction: column;
  }

  .header__dropdown-menu a {
    display: block;
    padding: var(--space-sm) var(--space-md);
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: background var(--transition-fast), color var(--transition-fast);
  }

  .header__dropdown-menu a:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
  }

  .header__dropdown-menu hr {
    margin: var(--space-xs) var(--space-md);
    border: none;
    border-top: 1px solid var(--border);
  }

  .header__external {
    font-size: 0.75em;
    opacity: 0.6;
  }

  /* --- Mobile-only links (hidden on desktop) --- */
  .header__link--mobile,
  .header__sep--mobile {
    display: none;
  }

  /* --- Theme Toggle --- */
  .theme-toggle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    margin-left: var(--space-xs);
  }

  .theme-toggle:hover {
    border-color: var(--text-primary);
    color: var(--text-primary);
  }

  .theme-icon--moon { display: none; }
  :global(html[data-theme="light"]) .theme-icon--sun { display: none; }
  :global(html[data-theme="light"]) .theme-icon--moon { display: block; }

  /* --- Hamburger Toggle --- */
  .header__toggle {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: var(--space-xs);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    min-width: 44px;
    min-height: 44px;
  }

  .header__toggle-bar {
    display: block;
    width: 22px;
    height: 2px;
    background: var(--text-primary);
    border-radius: 1px;
    transition: transform var(--transition-fast), opacity var(--transition-fast);
  }

  .header--open .header__toggle-bar:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .header--open .header__toggle-bar:nth-child(2) {
    opacity: 0;
  }

  .header--open .header__toggle-bar:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* --- Mobile (≤768px) --- */
  @media (max-width: 768px) {
    .header__toggle {
      display: flex;
    }

    .header__nav {
      display: none;
      position: absolute;
      top: 64px;
      left: 0;
      right: 0;
      flex-direction: column;
      background: var(--bg-chrome);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: var(--space-md) var(--space-lg);
      gap: 0;
    }

    .header--open .header__nav {
      display: flex;
    }

    /* Hide desktop dropdown on mobile */
    .header__dropdown {
      display: none;
    }

    /* Show mobile-only links */
    .header__link--mobile {
      display: flex;
    }

    .header__sep--mobile {
      display: block;
      margin: var(--space-xs) 0;
      border: none;
      border-top: 1px solid var(--border);
    }

    .header__link {
      padding: var(--space-sm) 0;
      font-size: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .header__link:last-of-type {
      border-bottom: none;
    }

  }
</style>
