---
const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');
const currentPath = Astro.url.pathname;

const primaryLinks = [
  { label: 'Work', href: `${base}#work` },
  { label: 'About', href: `${base}about/` },
  { label: 'Resume', href: `${base}resume/` },
];

const moreLinks = [
  { label: 'Gallery', href: `${base}gallery/` },
  { label: 'Essays', href: `${base}essays/` },
  { label: 'Dashboard', href: `${base}dashboard/` },
  { label: 'Architecture', href: `${base}architecture/` },
  { label: 'Products', href: `${base}products/` },
  { label: 'Community', href: `${base}community/` },
  { label: 'Consult', href: `${base}consult/` },
];

const connectLinks = [
  { label: 'Contact', href: 'mailto:padavano.anthony@gmail.com' },
  { label: 'LinkedIn', href: 'https://www.linkedin.com/in/anthony-james-padavano-98a40a186/', external: true },
  { label: 'GitHub', href: 'https://github.com/4444j99', external: true },
];
---

<header class="header">
  <div class="container header__inner">
    <a href={base} class="header__logo">
      <span class="header__name">4444j99</span>
    </a>
    <button
      class="header__toggle"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="main-nav"
    >
      <span class="header__toggle-bar"></span>
      <span class="header__toggle-bar"></span>
      <span class="header__toggle-bar"></span>
    </button>
    <nav class="header__nav" id="main-nav" aria-label="Main navigation">
      {primaryLinks.map(item => (
        <a
          href={item.href}
          class:list={['header__link', { 'header__link--active': currentPath === item.href }]}
        >
          {item.label}
        </a>
      ))}

      {/* Desktop dropdown */}
      <div class="header__dropdown">
        <button
          class="header__link header__dropdown-trigger"
          aria-expanded="false"
          aria-haspopup="true"
        >
          More
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 5l3 3 3-3"/>
          </svg>
        </button>
        <div class="header__dropdown-menu" role="menu">
          {moreLinks.map(item => (
            <a href={item.href} role="menuitem">{item.label}</a>
          ))}
          <hr />
          {connectLinks.map(item => (
            <a
              href={item.href}
              role="menuitem"
              {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
            >
              {item.label}{item.external && <span class="header__external" aria-hidden="true"> ↗</span>}
            </a>
          ))}
        </div>
      </div>

      {/* Mobile-only extra links (hidden on desktop) */}
      {moreLinks.map(item => (
        <a
          href={item.href}
          class:list={['header__link header__link--mobile', { 'header__link--active': currentPath === item.href }]}
        >
          {item.label}
        </a>
      ))}
      <hr class="header__sep--mobile" />
      {connectLinks.map(item => (
        <a
          href={item.href}
          class="header__link header__link--mobile"
          {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
        >
          {item.label}{item.external && <span class="header__external" aria-hidden="true"> ↗</span>}
        </a>
      ))}

      <div class="header__mode-switch" role="group" aria-label="Background intensity">
        <button data-mode="subtle" class="bg-mode-btn" aria-pressed="false" title="Subtle">S</button>
        <button data-mode="bold" class="bg-mode-btn" aria-pressed="false" title="Bold">B</button>
        <button data-mode="extreme" class="bg-mode-btn" aria-pressed="false" title="Extreme">E</button>
      </div>
    </nav>
  </div>
</header>

<script>
  function initHeader() {
    // --- Mobile menu: toggle, focus trap, scroll lock ---
    const headerEl = document.querySelector('.header') as HTMLElement | null;
    const toggleBtn = document.querySelector('.header__toggle') as HTMLButtonElement | null;
    const nav = document.querySelector('.header__nav') as HTMLElement | null;
    if (!headerEl || !toggleBtn || !nav) return;

    // Reset menu state after navigation
    headerEl.classList.remove('header--open');
    toggleBtn.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';

    function openMenu() {
      toggleBtn!.setAttribute('aria-expanded', 'true');
      headerEl!.classList.add('header--open');
      document.body.style.overflow = 'hidden';
      const ddMenu = document.querySelector('.header__dropdown-menu');
      const ddTrigger = document.querySelector('.header__dropdown-trigger');
      if (ddMenu) ddMenu.removeAttribute('data-open');
      if (ddTrigger) ddTrigger.setAttribute('aria-expanded', 'false');
    }

    function closeMenu() {
      toggleBtn!.setAttribute('aria-expanded', 'false');
      headerEl!.classList.remove('header--open');
      document.body.style.overflow = '';
      toggleBtn!.focus();
    }

    toggleBtn.addEventListener('click', () => {
      const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
      if (isOpen) closeMenu(); else openMenu();
    });

    nav.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if (headerEl!.classList.contains('header--open')) closeMenu();
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && headerEl!.classList.contains('header--open')) {
        closeMenu();
      }
    });

    nav.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab' || !headerEl!.classList.contains('header--open')) return;
      const focusable = nav!.querySelectorAll<HTMLElement>('a, button, [tabindex]:not([tabindex="-1"])');
      if (focusable.length === 0) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });

    // --- Dropdown toggle ---
    const trigger = document.querySelector('.header__dropdown-trigger') as HTMLButtonElement | null;
    const menu = document.querySelector('.header__dropdown-menu') as HTMLElement | null;
    if (!trigger || !menu) return;

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = menu.hasAttribute('data-open');
      if (isOpen) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      } else {
        menu.setAttribute('data-open', '');
        trigger.setAttribute('aria-expanded', 'true');
      }
    });

    document.addEventListener('click', (e) => {
      if (!menu.hasAttribute('data-open')) return;
      if (!menu.contains(e.target as Node) && e.target !== trigger) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && menu.hasAttribute('data-open')) {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
        trigger.focus();
      }
    });

    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        menu.removeAttribute('data-open');
        trigger.setAttribute('aria-expanded', 'false');
      });
    });
  }

  document.addEventListener('astro:page-load', initHeader);
</script>

<style>
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-chrome);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
  }

  .header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .header__logo {
    text-decoration: none;
    padding: 0.5rem 0;
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  .header__name {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-primary);
    letter-spacing: -0.01em;
  }

  /* --- Nav --- */
  .header__nav {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
  }

  .header__link {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
    padding: 0.5rem 0.25rem;
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  .header__link:hover,
  .header__link--active {
    color: var(--text-primary);
  }

  /* --- Dropdown --- */
  .header__dropdown {
    position: relative;
  }

  .header__dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .header__dropdown-trigger svg {
    transition: transform var(--transition-fast);
  }

  .header__dropdown-trigger[aria-expanded="true"] svg {
    transform: rotate(180deg);
  }

  .header__dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 180px;
    background: var(--bg-card);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: var(--space-xs) 0;
    z-index: 200;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .header__dropdown-menu[data-open] {
    display: flex;
    flex-direction: column;
  }

  .header__dropdown-menu a {
    display: block;
    padding: var(--space-sm) var(--space-md);
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: background var(--transition-fast), color var(--transition-fast);
  }

  .header__dropdown-menu a:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
  }

  .header__dropdown-menu hr {
    margin: var(--space-xs) var(--space-md);
    border: none;
    border-top: 1px solid var(--border);
  }

  .header__external {
    font-size: 0.75em;
    opacity: 0.6;
  }

  /* --- Mobile-only links (hidden on desktop) --- */
  .header__link--mobile,
  .header__sep--mobile {
    display: none;
  }

  /* --- S/B/E Mode Switch --- */
  .header__mode-switch {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-left: var(--space-sm);
  }

  .header__mode-switch .bg-mode-btn {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .header__mode-switch .bg-mode-btn:hover {
    border-color: var(--text-primary);
    color: var(--text-primary);
  }

  .header__mode-switch .bg-mode-btn--active {
    background: var(--text-primary);
    color: var(--bg-card);
    border-color: var(--text-primary);
  }

  /* --- Hamburger Toggle --- */
  .header__toggle {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    min-width: 44px;
    min-height: 44px;
  }

  .header__toggle-bar {
    display: block;
    width: 22px;
    height: 2px;
    background: var(--text-primary);
    border-radius: 1px;
    transition: transform var(--transition-fast), opacity var(--transition-fast);
  }

  .header--open .header__toggle-bar:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .header--open .header__toggle-bar:nth-child(2) {
    opacity: 0;
  }

  .header--open .header__toggle-bar:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* --- Mobile (≤768px) --- */
  @media (max-width: 768px) {
    .header__toggle {
      display: flex;
    }

    .header__nav {
      display: none;
      position: absolute;
      top: 64px;
      left: 0;
      right: 0;
      flex-direction: column;
      background: var(--bg-chrome);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: var(--space-md) var(--space-lg);
      gap: 0;
    }

    .header--open .header__nav {
      display: flex;
    }

    /* Hide desktop dropdown on mobile */
    .header__dropdown {
      display: none;
    }

    /* Show mobile-only links */
    .header__link--mobile {
      display: flex;
    }

    .header__sep--mobile {
      display: block;
      margin: var(--space-xs) 0;
      border: none;
      border-top: 1px solid var(--border);
    }

    .header__link {
      padding: var(--space-sm) 0;
      font-size: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .header__link:last-of-type {
      border-bottom: none;
    }

    .header__mode-switch {
      margin-left: 0;
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border);
      justify-content: center;
    }
  }
</style>
