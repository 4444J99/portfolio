---
import type { QualityMetrics } from '../../types/data';

interface Props {
  quality: QualityMetrics;
  base: string;
}

const { quality, base } = Astro.props;
const sources = quality.sources ?? {
  tests: 'unavailable',
  coverage: 'unavailable',
  lighthouse: 'unavailable',
  a11yStatic: 'unavailable',
  a11yRuntime: 'unavailable',
  build: 'unavailable',
};

const perfValue = quality.lighthouse.performance === null ? 'n/a' : String(quality.lighthouse.performance);
const a11yValue = quality.lighthouse.accessibility === null ? 'n/a' : String(quality.lighthouse.accessibility);
const seoValue = quality.lighthouse.seo === null ? 'n/a' : String(quality.lighthouse.seo);
const testsDetail = quality.tests.total === null ? 'Tests: n/a' : `${quality.tests.total} tests`;
const staticA11yIssueCount = quality.a11y.static.critical !== null && quality.a11y.static.serious !== null
  ? quality.a11y.static.critical + quality.a11y.static.serious
  : null;
const runtimeA11yIssueCount = quality.a11y.runtime.critical !== null && quality.a11y.runtime.serious !== null
  ? quality.a11y.runtime.critical + quality.a11y.runtime.serious
  : null;
const combinedA11yPages =
  (quality.a11y.static.pagesAudited ?? 0) + (quality.a11y.runtime.pagesAudited ?? 0);
const runtimeFocusDetail = quality.a11y.runtime.focusChecks === null
  ? 'focus n/a'
  : `${quality.a11y.runtime.focusChecks} focus checks`;
---

<section class="section">
  <div class="container">
    <h2 class="section__heading">Quality Gates</h2>
    <p class="quality-intro">Automated quality infrastructure running on every push — tests, accessibility audits, performance budgets, and HTML validation.</p>

    <div class="quality-grid">
      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
        </div>
        <div class="quality-card__value">{quality.tests.files}</div>
        <div class="quality-card__label">Test Files</div>
        <div class="quality-card__detail">{testsDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <div class="quality-card__value">{combinedA11yPages === 0 ? 'n/a' : combinedA11yPages}</div>
        <div class="quality-card__label">A11y Audits</div>
        <div class="quality-card__detail">
          Static {staticA11yIssueCount === null ? 'n/a' : staticA11yIssueCount}
          {' · '}
          Runtime {runtimeA11yIssueCount === null ? 'n/a' : runtimeA11yIssueCount}
          {' · '}
          {runtimeFocusDetail}
        </div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
        </div>
        <div class="quality-card__value">{perfValue}</div>
        <div class="quality-card__label">Lighthouse Perf</div>
        <div class="quality-card__detail">A11y {a11yValue} · SEO {seoValue}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
          </svg>
        </div>
        <div class="quality-card__value">{quality.build.pages}</div>
        <div class="quality-card__label">HTML Pages</div>
        <div class="quality-card__detail">Validated & link-checked</div>
      </div>
    </div>

    <div class="quality-badges">
      <img src={`${base}badges/tests.svg`} alt={`Tests: ${quality.tests.files} files`} width="90" height="20" />
      <img src={`${base}badges/a11y.svg`} alt={`Accessibility: ${quality.a11y.status}`} width="80" height="20" />
      <img src={`${base}badges/lighthouse-perf.svg`} alt={`Performance: ${perfValue}`} width="120" height="20" />
      <img src={`${base}badges/lighthouse-a11y.svg`} alt={`Accessibility: ${a11yValue}`} width="120" height="20" />
      <img src={`${base}badges/lighthouse-seo.svg`} alt={`SEO: ${seoValue}`} width="80" height="20" />
      <img src={`${base}badges/pages.svg`} alt={`Pages: ${quality.build.pages}`} width="80" height="20" />
    </div>

    <p class="quality-timestamp">Last updated: {new Date(quality.generated).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</p>
    <p class="quality-sources">
      Sources: tests ({sources.tests}) · coverage ({sources.coverage}) · lighthouse ({sources.lighthouse}) · a11y static ({sources.a11yStatic}) · a11y runtime ({sources.a11yRuntime}) · build ({sources.build})
    </p>
  </div>
</section>

<style>
  .quality-intro {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xl);
    max-width: 55ch;
  }

  .quality-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }

  .quality-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: var(--space-lg);
    text-align: center;
    transition: border-color var(--transition-fast);
  }

  .quality-card:hover {
    border-color: var(--border-hover);
  }

  .quality-card__icon {
    color: var(--accent);
    margin-bottom: var(--space-sm);
  }

  .quality-card__value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.1;
  }

  .quality-card__label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: var(--space-xs);
  }

  .quality-card__detail {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: var(--space-xs);
  }

  .quality-badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .quality-badges img {
    height: 20px;
  }

  .quality-timestamp {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .quality-sources {
    margin-top: var(--space-sm);
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  @media (max-width: 768px) {
    .quality-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
