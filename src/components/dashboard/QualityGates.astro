---
import type { QualityMetrics } from '../../types/data';

interface Props {
  quality: QualityMetrics;
  base: string;
}

const { quality, base } = Astro.props;
const security = quality.security ?? {
  critical: null,
  high: null,
  moderate: null,
  low: null,
  total: null,
  githubOpenAlerts: null,
  githubAdvisoryStatus: 'unknown',
  prodCounts: { critical: null, high: null, moderate: null, low: null, total: null },
  devCounts: { critical: null, high: null, moderate: null, low: null, total: null },
  allowlistActive: 0,
  policyCheckpoint: null,
  status: 'unknown',
  source: null,
  githubSource: null,
};
const performance = quality.performance ?? {
  routeBudgetsStatus: 'unknown',
  chunkBudgetsStatus: 'unknown',
  interactionBudgetsStatus: 'unknown',
  routeBudgetCheckpoint: null,
  chunkBudgetCheckpoint: null,
  interactionBudgetCheckpoint: null,
  largestChunks: [],
  interactiveRouteJsTotals: {},
  routeJsTotals: {},
  source: null,
};
const runtimeErrors = quality.runtimeErrors ?? {
  status: 'unknown',
  total: null,
  uncategorized: null,
  allowlisted: null,
  source: null,
};
const stability = quality.stability ?? {
  status: 'unknown',
  consecutiveSuccess: null,
  requiredConsecutive: null,
  source: null,
};
const sources = quality.sources ?? {
  tests: 'unavailable',
  security: 'unavailable',
  securityProd: 'unavailable',
  securityGithub: 'unavailable',
  securityDrift: 'unavailable',
  coverage: 'unavailable',
  lighthouse: 'unavailable',
  a11yStatic: 'unavailable',
  a11yRuntime: 'unavailable',
  runtimeCoverage: 'unavailable',
  e2eSmoke: 'unavailable',
  runtimeErrors: 'unavailable',
  greenRuns: 'unavailable',
  ledger: 'unavailable',
  policyGovernance: 'unavailable',
  performance: 'unavailable',
  build: 'unavailable',
};

const perfValue = quality.lighthouse.performance === null ? 'n/a' : String(quality.lighthouse.performance);
const a11yValue = quality.lighthouse.accessibility === null ? 'n/a' : String(quality.lighthouse.accessibility);
const seoValue = quality.lighthouse.seo === null ? 'n/a' : String(quality.lighthouse.seo);
const testsDetail = quality.tests.total === null ? 'Tests: n/a' : `${quality.tests.total} tests`;
const staticA11yIssueCount = quality.a11y.static.critical !== null && quality.a11y.static.serious !== null
  ? quality.a11y.static.critical + quality.a11y.static.serious
  : null;
const runtimeA11yIssueCount = quality.a11y.runtime.critical !== null && quality.a11y.runtime.serious !== null
  ? quality.a11y.runtime.critical + quality.a11y.runtime.serious
  : null;
const combinedA11yPages =
  (quality.a11y.static.pagesAudited ?? 0) + (quality.a11y.runtime.pagesAudited ?? 0);
const runtimeFocusDetail = quality.a11y.runtime.focusChecks === null
  ? 'focus n/a'
  : `${quality.a11y.runtime.focusChecks} focus checks`;
const runtimeCoverageDetail = quality.a11y.runtime.coveragePct === null
  ? 'coverage n/a'
  : `${quality.a11y.runtime.coveragePct}% route coverage`;
const securityDetail = security.total === null
  ? 'critical n/a · high n/a'
  : `critical ${security.critical ?? 0} · high ${security.high ?? 0} · moderate ${security.moderate ?? 0} · low ${security.low ?? 0}`;
const securityBreakdown = security.prodCounts.total === null
  ? 'prod/dev split n/a'
  : `prod ${security.prodCounts.total ?? 0} · dev ${security.devCounts.total ?? 0}`;
const securityCheckpointDetail = security.policyCheckpoint
  ? `checkpoint ${security.policyCheckpoint.date} (moderate<=${security.policyCheckpoint.maxModerate}, low<=${security.policyCheckpoint.maxLow})`
  : 'checkpoint n/a';
const securityAllowlistDetail = `allowlist active ${security.allowlistActive ?? 0}`;
const securityGithubDetail = `github alerts ${security.githubOpenAlerts ?? 'n/a'} (${security.githubAdvisoryStatus})`;
const perfBudgetDetail = performance.routeBudgetsStatus;
const perfBudgetCompositeDetail = `route ${performance.routeBudgetsStatus} · chunk ${performance.chunkBudgetsStatus} · interaction ${performance.interactionBudgetsStatus}`;
const runtimeErrorDetail = runtimeErrors.total === null
  ? 'runtime telemetry n/a'
  : `events ${runtimeErrors.total} · uncategorized ${runtimeErrors.uncategorized ?? 0}`;
const greenRunDetail = stability.consecutiveSuccess === null
  ? 'green run history n/a'
  : `${stability.consecutiveSuccess}/${stability.requiredConsecutive ?? 'n/a'} consecutive`;
---

<section class="section">
  <div class="container">
    <h2 class="section__heading">Quality Gates</h2>
    <p class="quality-intro">Automated quality infrastructure running on every push — tests, accessibility audits, performance budgets, and HTML validation.</p>

    <div class="quality-grid">
      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
        </div>
        <div class="quality-card__value">{quality.tests.files}</div>
        <div class="quality-card__label">Test Files</div>
        <div class="quality-card__detail">{testsDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 4h16v16H4z"/><path d="M8 12h8"/><path d="M8 8h8"/><path d="M8 16h5"/>
          </svg>
        </div>
        <div class="quality-card__value">{security.status.toUpperCase()}</div>
        <div class="quality-card__label">Security Audit</div>
        <div class="quality-card__detail">{securityDetail}</div>
        <div class="quality-card__detail">{securityBreakdown}</div>
        <div class="quality-card__detail">{securityAllowlistDetail}</div>
        <div class="quality-card__detail">{securityGithubDetail}</div>
        <div class="quality-card__detail">{securityCheckpointDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <div class="quality-card__value">{combinedA11yPages === 0 ? 'n/a' : combinedA11yPages}</div>
        <div class="quality-card__label">A11y Audits</div>
        <div class="quality-card__detail">
          Static {staticA11yIssueCount === null ? 'n/a' : staticA11yIssueCount}
          {' · '}
          Runtime {runtimeA11yIssueCount === null ? 'n/a' : runtimeA11yIssueCount}
          {' · '}
          {runtimeFocusDetail} {' · '} {runtimeCoverageDetail}
        </div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
        </div>
        <div class="quality-card__value">{perfValue}</div>
        <div class="quality-card__label">Lighthouse Perf</div>
        <div class="quality-card__detail">A11y {a11yValue} · SEO {seoValue}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 3h18v4H3z"/><path d="M7 7v14"/><path d="M17 7v14"/><path d="M3 21h18"/>
          </svg>
        </div>
        <div class="quality-card__value">{perfBudgetDetail.toUpperCase()}</div>
        <div class="quality-card__label">Perf Budgets</div>
        <div class="quality-card__detail">{perfBudgetCompositeDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          </svg>
        </div>
        <div class="quality-card__value">{runtimeErrors.status.toUpperCase()}</div>
        <div class="quality-card__label">Runtime Errors</div>
        <div class="quality-card__detail">{runtimeErrorDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M3 12h4l3 8 4-16 3 8h4"/>
          </svg>
        </div>
        <div class="quality-card__value">{stability.status.toUpperCase()}</div>
        <div class="quality-card__label">Green Run Tracker</div>
        <div class="quality-card__detail">{greenRunDetail}</div>
      </div>

      <div class="quality-card">
        <div class="quality-card__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
          </svg>
        </div>
        <div class="quality-card__value">{quality.build.pages}</div>
        <div class="quality-card__label">HTML Pages</div>
        <div class="quality-card__detail">Validated & link-checked</div>
      </div>
    </div>

    <div class="quality-badges">
      <img src={`${base}badges/tests.svg`} alt={`Tests: ${quality.tests.files} files`} width="90" height="20" />
      <img src={`${base}badges/security.svg`} alt={`Security: ${security.status}`} width="95" height="20" />
      <img src={`${base}badges/a11y.svg`} alt={`Accessibility: ${quality.a11y.status}`} width="80" height="20" />
      <img src={`${base}badges/lighthouse-perf.svg`} alt={`Performance: ${perfValue}`} width="120" height="20" />
      <img src={`${base}badges/lighthouse-a11y.svg`} alt={`Accessibility: ${a11yValue}`} width="120" height="20" />
      <img src={`${base}badges/lighthouse-seo.svg`} alt={`SEO: ${seoValue}`} width="80" height="20" />
      <img src={`${base}badges/perf-budgets.svg`} alt={`Perf budgets: ${perfBudgetDetail}`} width="120" height="20" />
      <img src={`${base}badges/pages.svg`} alt={`Pages: ${quality.build.pages}`} width="80" height="20" />
    </div>

    <p class="quality-timestamp">Last updated: {new Date(quality.generated).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</p>
    <p class="quality-sources">
      Sources: tests ({sources.tests}) · security full ({sources.security}) · security prod ({sources.securityProd}) · security github ({sources.securityGithub}) · security drift ({sources.securityDrift}) · coverage ({sources.coverage}) · lighthouse ({sources.lighthouse}) · a11y static ({sources.a11yStatic}) · a11y runtime ({sources.a11yRuntime}) · runtime coverage ({sources.runtimeCoverage}) · e2e smoke ({sources.e2eSmoke}) · runtime errors ({sources.runtimeErrors}) · green runs ({sources.greenRuns}) · ledger ({sources.ledger}) · performance ({sources.performance}) · build ({sources.build})
    </p>
  </div>
</section>

<style>
  .quality-intro {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xl);
    max-width: 55ch;
  }

  .quality-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }

  .quality-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: var(--space-lg);
    text-align: center;
    transition: border-color var(--transition-fast);
  }

  .quality-card:hover {
    border-color: var(--border-hover);
  }

  .quality-card__icon {
    color: var(--accent);
    margin-bottom: var(--space-sm);
  }

  .quality-card__value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.1;
  }

  .quality-card__label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: var(--space-xs);
  }

  .quality-card__detail {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: var(--space-xs);
  }

  .quality-badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .quality-badges img {
    height: 20px;
  }

  .quality-timestamp {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .quality-sources {
    margin-top: var(--space-sm);
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  @media (max-width: 768px) {
    .quality-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
