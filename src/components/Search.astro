---
import { base } from '../utils/paths';

// Search component: Cmd+K trigger with Pagefind UI in a dialog overlay.
// Pagefind UI is lazy-loaded on first interaction.
// Uses is:inline to avoid Vite module bundling — prevents View Transition stalls.
---

<button class="search-trigger" aria-label="Search (Cmd+K)" type="button">
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <circle cx="6.5" cy="6.5" r="5"/>
    <path d="M10.5 10.5L15 15"/>
  </svg>
  <kbd class="search-trigger__kbd">
    <span class="search-trigger__kbd-symbol">⌘</span>K
  </kbd>
</button>

<dialog class="search-dialog" aria-label="Site search" data-base={base}>
  <div class="search-dialog__inner">
    <div id="pagefind-container"></div>
    <button class="search-dialog__close" aria-label="Close search" type="button">
      <kbd>Esc</kbd>
    </button>
  </div>
</dialog>

<script is:inline>
  (function () {
    var BASE = '/portfolio/';
    var globalScope = globalThis;
    var state = globalScope.__portfolioSearchState;
    if (!state) {
      state = {
        controller: null,
        pagefindLoaded: false,
      };
      globalScope.__portfolioSearchState = state;
    }

    function initSearch() {
      if (state.controller) state.controller.abort();
      var controller = new AbortController();
      var signal = controller.signal;
      state.controller = controller;

      var trigger = document.querySelector('.search-trigger');
      var dialog = document.querySelector('.search-dialog');
      var closeBtn = document.querySelector('.search-dialog__close');
      if (!trigger || !dialog) return;
      BASE = dialog.dataset.base || BASE;

      function focusSearchInput() {
        var input = document.querySelector('#pagefind-container input');
        if (input) input.focus();
      }

      function openSearch() {
        if (!dialog.open) dialog.showModal();
        loadPagefind();
        focusSearchInput();
      }

      function closeSearch() {
        if (dialog.open) dialog.close();
      }

      trigger.addEventListener('click', openSearch, { signal });
      if (closeBtn) closeBtn.addEventListener('click', closeSearch, { signal });

      // Click outside to close
      dialog.addEventListener('click', function (e) {
        if (e.target === dialog) closeSearch();
      }, { signal });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && dialog.open) {
          closeSearch();
          return;
        }

        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (dialog.open) {
            closeSearch();
          } else {
            openSearch();
          }
        }
      }, { signal });

      document.addEventListener('astro:before-swap', function () {
        controller.abort();
      }, { once: true, signal });
    }

    function loadPagefind() {
      if (state.pagefindLoaded) return;
      state.pagefindLoaded = true;

      var container = document.getElementById('pagefind-container');
      if (!container) return;

      // Load Pagefind UI CSS
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = BASE + 'pagefind/pagefind-ui.css';
      document.head.appendChild(link);

      // Load Pagefind UI JS via script tag (no ES module import in is:inline)
      try {
        var script = document.createElement('script');
        script.src = BASE + 'pagefind/pagefind-ui.js';
        script.onload = function () {
          if (window.PagefindUI) {
            new window.PagefindUI({
              element: container,
              showSubResults: true,
              showImages: false,
              baseUrl: BASE,
            });
            setTimeout(function () {
              var input = container.querySelector('input');
              if (input) input.focus();
            }, 50);
          }
        };
        script.onerror = function () {
          container.textContent = 'Search unavailable \u2014 run a production build to enable Pagefind.';
        };
        document.head.appendChild(script);
      } catch (err) {
        container.textContent = 'Search unavailable.';
      }
    }

    // Dual init: covers initial load + View Transition navigations
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearch);
    } else {
      initSearch();
    }
    document.addEventListener('astro:page-load', initSearch);
  })();
</script>

<style>
  .search-trigger {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 0.35rem 0.6rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    font-family: inherit;
    font-size: 0.8rem;
    transition: border-color var(--transition-fast), color var(--transition-fast);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .search-trigger:hover {
    border-color: var(--text-muted);
    color: var(--text-primary);
  }

  .search-trigger__kbd {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2xs);
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    background: var(--bg-secondary);
    padding: 0.1em 0.4em;
    border-radius: 3px;
    border: 1px solid var(--border);
    line-height: 1;
  }

  .search-trigger__kbd-symbol {
    font-size: 0.75rem;
  }

  /* Dialog overlay */
  .search-dialog {
    position: fixed;
    inset: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    background: transparent;
    border: none;
    padding: 0;
    z-index: 1000;
  }

  .search-dialog::backdrop {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .search-dialog__inner {
    max-width: 640px;
    margin: 10vh auto 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5);
    position: relative;
    max-height: 70vh;
    overflow-y: auto;
  }

  .search-dialog__close {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    padding: 0.2em 0.5em;
    border-radius: 3px;
    transition: color var(--transition-fast);
  }

  .search-dialog__close:hover {
    color: var(--text-primary);
  }

  @media (max-width: 768px) {
    .search-trigger__kbd {
      display: none;
    }

    .search-dialog__inner {
      margin: 5vh var(--space-md) 0;
      max-height: 80vh;
    }
  }
</style>

<style is:global>
  /* Pagefind UI theme overrides */
  .search-dialog .pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-text: var(--text-primary);
    --pagefind-ui-background: transparent;
    --pagefind-ui-border: var(--border);
    --pagefind-ui-tag: var(--bg-secondary);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 6px;
    --pagefind-ui-font: var(--font-body);
  }

  .search-dialog .pagefind-ui__search-input {
    background: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
  }

  .search-dialog .pagefind-ui__result-link {
    color: var(--accent-text) !important;
  }

  .search-dialog .pagefind-ui__result-excerpt {
    color: var(--text-secondary) !important;
  }
</style>
