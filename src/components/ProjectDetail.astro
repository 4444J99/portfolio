---
import SketchContainer from './sketches/SketchContainer.astro';
import TableOfContents from './TableOfContents.astro';
import GithubPagesTracking from './scripts/GithubPagesTracking.astro';
import { projectIndex } from '../data/project-index';
import pagesDirectory from '../data/github-pages.json';
import { base } from '../utils/paths';

interface Badge {
  src: string;
  alt: string;
  href?: string;
}

interface Props {
  title: string;
  tagline: string;
  tags: string[];
  repo?: string;
  liveUrl?: string;
  badges?: Badge[];
  heroImage?: { src: string; alt: string };
  sketchId?: string;
}

const { title, tagline, tags, repo, liveUrl, badges, heroImage, sketchId = 'recursive-tree' } = Astro.props;

interface PagesRepo {
  owner: string;
  repo: string;
  fullName: string;
  pageUrl: string;
  repoUrl: string;
  featured: boolean;
  priority: number;
  hidden: boolean;
  label: string | null;
  probeMethod?: string | null;
  probeLatencyMs?: number | null;
  lastError?: string | null;
}

function parseGitHubRepo(url?: string) {
  if (!url) return null;
  const match = url.match(/^https?:\/\/github\.com\/([^/]+)\/([^/#?]+)/i);
  if (!match) return null;
  return {
    owner: match[1].toLowerCase(),
    repo: match[2].replace(/\.git$/i, '').toLowerCase(),
  };
}

// Derive current slug from URL and find related projects by shared tags
const segments = Astro.url.pathname.replace(/\/$/, '').split('/');
const currentSlug = segments[segments.length - 1];
const tagSet = new Set(tags);
const related = projectIndex
  .filter(p => p.slug !== currentSlug)
  .map(p => ({ ...p, shared: p.tags.filter(t => tagSet.has(t)).length }))
  .filter(p => p.shared > 0)
  .sort((a, b) => b.shared - a.shared)
  .slice(0, 3);

// Prev/next sequential navigation
const currentIdx = projectIndex.findIndex(p => p.slug === currentSlug);
const prevProject = currentIdx > 0 ? projectIndex[currentIdx - 1] : null;
const nextProject = currentIdx < projectIndex.length - 1 ? projectIndex[currentIdx + 1] : null;

const repoRef = parseGitHubRepo(repo);
const pagesRepos = ((pagesDirectory as { repos?: PagesRepo[] }).repos ?? []).filter((entry) => !entry.hidden);
const relatedPages = repoRef
  ? (() => {
      const exact = pagesRepos.find(
        (entry) =>
          entry.owner.toLowerCase() === repoRef.owner &&
          entry.repo.toLowerCase() === repoRef.repo
      );

      const ownerPool = pagesRepos
        .filter((entry) => entry.owner.toLowerCase() === repoRef.owner && entry !== exact)
        .sort(
          (a, b) =>
            Number(b.featured) - Number(a.featured) ||
            b.priority - a.priority ||
            a.repo.localeCompare(b.repo, undefined, { sensitivity: 'base' })
        );

      const familyTokens = repoRef.repo.split(/[-_]+/).filter((token) => token.length >= 4);
      const familyMatches = ownerPool.filter((entry) =>
        familyTokens.some((token) => entry.repo.toLowerCase().includes(token))
      );

      const combined = [
        ...(exact ? [exact] : []),
        ...familyMatches,
        ...ownerPool,
      ];

      const deduped = [];
      const seen = new Set();
      for (const entry of combined) {
        const key = entry.fullName.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        deduped.push(entry);
      }

      return deduped.slice(0, 6);
    })()
  : [];
---

<article class="project">
  <header class="project__header">
    <a href={base} class="project__back">&larr; All projects</a>
    <div class="project__tags">
      {tags.map(tag => <span class="tag">{tag}</span>)}
    </div>
    <h1 class="project__title" transition:name={`project-${currentSlug}`} transition:animate="initial">{title}</h1>
    <p class="project__tagline">{tagline}</p>
    {badges && badges.length > 0 && (
      <div class="project__badges">
        {badges.map(b => b.href
          ? <a href={b.href} target="_blank" rel="noopener noreferrer"><img src={b.src} alt={b.alt} loading="lazy" /></a>
          : <img src={b.src} alt={b.alt} loading="lazy" />
        )}
      </div>
    )}
    {(repo || liveUrl) && (
      <div class="project__links">
        {repo && <a href={repo} target="_blank" rel="noopener noreferrer" class="project__link">GitHub &rarr;</a>}
        {liveUrl && <a href={liveUrl} target="_blank" rel="noopener noreferrer" class="project__link">Live &rarr;</a>}
      </div>
    )}
    {relatedPages.length > 0 && (
      <section class="project__pages" aria-label="Related GitHub Pages links">
        <h2 class="project__pages-heading">Related Live Sites</h2>
        <ul class="project__pages-list">
          {relatedPages.map((entry) => (
            <li class="project__pages-item">
              <a
                href={entry.pageUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="project__pages-link"
                data-gh-pages-track
                data-track-surface="project-related"
                data-track-owner={entry.owner}
                data-track-repo={entry.repo}
                data-track-target="page">
                {entry.label ?? entry.fullName}
              </a>
              <a
                href={entry.repoUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="project__pages-repo"
                data-gh-pages-track
                data-track-surface="project-related"
                data-track-owner={entry.owner}
                data-track-repo={entry.repo}
                data-track-target="repo">
                repo
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </header>
  {heroImage && (
    <img class="project__hero-image" src={heroImage.src} alt={heroImage.alt} loading="lazy" />
  )}
  <div class="sketch-accent">
    <SketchContainer sketchId={sketchId} height="250px" mobileHeight="180px" ariaLabel={`Generative sketch: ${sketchId}`} data-tags={tags.join(',')} />
  </div>
  <div class="project__content-grid">
    <TableOfContents />
    <div class="project__body prose">
      <slot />
    </div>
  </div>
  {related.length > 0 && (
    <nav class="related" aria-label="Related projects">
      <h2 class="related__heading">Related Projects</h2>
      <ul class="related__list">
        {related.map(r => (
          <li class="related__item">
            <a href={`${base}projects/${r.slug}/`} class="related__link">
              <span class="related__title">{r.title}</span>
              <span class="related__tags">{r.tags.filter(t => tagSet.has(t)).join(', ')}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )}
  {(prevProject || nextProject) && (
    <nav class="project-nav" aria-label="Project navigation">
      {prevProject ? (
        <a href={`${base}projects/${prevProject.slug}/`} class="project-nav__link project-nav__link--prev">
          <span class="project-nav__arrow" aria-hidden="true">&larr;</span>
          <span class="project-nav__meta">
            <span class="project-nav__label">Previous</span>
            <span class="project-nav__title">{prevProject.title}</span>
          </span>
        </a>
      ) : <span />}
      {nextProject ? (
        <a href={`${base}projects/${nextProject.slug}/`} class="project-nav__link project-nav__link--next">
          <span class="project-nav__meta">
            <span class="project-nav__label">Next</span>
            <span class="project-nav__title">{nextProject.title}</span>
          </span>
          <span class="project-nav__arrow" aria-hidden="true">&rarr;</span>
        </a>
      ) : <span />}
    </nav>
  )}
</article>

<style>
  .project {
    max-width: 960px;
    margin: 0 auto;
    padding: var(--space-3xl) var(--space-lg);
  }

  .project__header {
    margin-bottom: var(--space-3xl);
  }

  .project__back {
    display: inline-block;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: var(--space-xl);
    transition: color var(--transition-fast);
  }

  .project__back:hover {
    color: var(--text-primary);
  }

  .project__tags {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
  }

  .project__title {
    margin-bottom: var(--space-sm);
  }

  .project__tagline {
    font-size: 1.15rem;
    color: var(--accent-text);
    font-style: italic;
    max-width: 55ch;
  }

  .project__badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
  }

  .project__badges img {
    height: 20px;
    border-radius: 3px;
  }

  .project__hero-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: var(--space-xl);
  }

  .project__links {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
  }

  .project__link {
    font-size: 0.9rem;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    padding: var(--space-sm) var(--space-md);
    border-radius: 6px;
    transition: all var(--transition-fast);
  }

  .project__link:hover {
    color: var(--accent-text);
    border-color: var(--accent);
  }

  .project__pages {
    margin-top: var(--space-lg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: var(--space-md);
    background: var(--bg-card);
  }

  .project__pages-heading {
    margin: 0 0 var(--space-sm);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .project__pages-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: var(--space-xs);
  }

  .project__pages-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .project__pages-link {
    font-size: 0.86rem;
    color: var(--text-primary);
  }

  .project__pages-link:hover {
    color: var(--accent-text);
  }

  .project__pages-repo {
    font-size: 0.75rem;
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.1rem 0.45rem;
  }

  .project__pages-repo:hover {
    color: var(--text-secondary);
    border-color: var(--accent);
  }

  .project__content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
  }

  @media (min-width: 769px) {
    .project__content-grid {
      grid-template-columns: 180px 1fr;
    }

    .project__content-grid :global(.toc) {
      position: sticky;
      top: 84px; /* header height (64px) + spacing */
      align-self: start;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
  }

  .project__body {
    line-height: 1.8;
    min-width: 0;
  }
  .sketch-accent {
    margin-bottom: var(--space-xl);
  }

  .related {
    margin-top: var(--space-3xl);
    padding-top: var(--space-2xl);
    border-top: 1px solid var(--border);
  }

  .related__heading {
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: var(--space-lg);
  }

  .related__list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .related__link {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border);
    border-radius: 6px;
    transition: all var(--transition-fast);
  }

  .related__link:hover {
    border-color: var(--accent);
    background: var(--bg-card);
  }

  .related__title {
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  .related__tags {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  /* Prev/Next Navigation */
  .project-nav {
    display: flex;
    justify-content: space-between;
    gap: var(--space-md);
    margin-top: var(--space-2xl);
    padding-top: var(--space-2xl);
    border-top: 1px solid var(--border);
  }

  .project-nav__link {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border);
    border-radius: 6px;
    text-decoration: none;
    transition: border-color var(--transition-fast), background var(--transition-fast);
    max-width: 48%;
  }

  .project-nav__link:hover {
    border-color: var(--accent);
    background: var(--bg-card);
  }

  .project-nav__link--next {
    margin-left: auto;
    text-align: right;
  }

  .project-nav__arrow {
    font-size: 1.1rem;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  .project-nav__meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
  }

  .project-nav__label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .project-nav__title {
    font-size: 0.85rem;
    color: var(--text-primary);
    line-height: 1.3;
  }

  @media (max-width: 768px) {
    .project {
      padding: var(--space-2xl) var(--space-md);
    }

    .related__link {
      flex-direction: column;
      gap: var(--space-xs);
    }

    .project-nav {
      flex-direction: column;
    }

    .project-nav__link {
      max-width: 100%;
    }

    .project-nav__link--next {
      flex-direction: row-reverse;
      text-align: left;
    }
  }
</style>

<GithubPagesTracking />
