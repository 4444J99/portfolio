<script>
  const globalScope = globalThis as typeof globalThis & {
    __portfolioBootstrapState?: { listenersAttached: boolean };
  };
  const bootstrapState = globalScope.__portfolioBootstrapState ??= {
    listenersAttached: false,
  };

  function annotateScrollableTables() {
    document.querySelectorAll<HTMLElement>('.table-wrap').forEach((el, index) => {
      if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
      if (!el.hasAttribute('role')) el.setAttribute('role', 'region');
      if (!el.hasAttribute('aria-label')) {
        const figureCaption = el.closest('figure')?.querySelector('figcaption')?.textContent?.trim();
        el.setAttribute('aria-label', figureCaption || `Scrollable data table ${index + 1}`);
      }
    });
  }

  if (!bootstrapState.listenersAttached) {
    // Service worker registration — runs once on initial load
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/portfolio/sw.js').catch(() => {});
    }

    // Focus management for View Transitions — move focus to main content
    // after page swap so screen readers announce the new page
    document.addEventListener('astro:after-swap', () => {
      const main = document.getElementById('main-content');
      if (main) {
        main.setAttribute('tabindex', '-1');
        main.focus({ preventScroll: true });
      }
    });

    document.addEventListener('astro:page-load', annotateScrollableTables);
    bootstrapState.listenersAttached = true;
  }

  annotateScrollableTables();
</script>
