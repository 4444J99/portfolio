---
import Layout from '../layouts/Layout.astro';
import SketchContainer from '../components/sketches/SketchContainer.astro';
import ChartContainer from '../components/charts/ChartContainer.astro';

import type { GraphData, GraphNode, GraphEdge } from '../types/data';
import graphData from '../data/graph.json';
import { organColors } from '../data/organ-colors';
import { buildArchitectureNavigatorData } from '../utils/architecture-data';

const navigatorData = buildArchitectureNavigatorData();

const typedGraph = graphData as GraphData;
const organNodes = [...new Set(typedGraph.nodes.map((n: GraphNode) => n.organ))];
const organEdges = typedGraph.edges.map((e: GraphEdge) => {
  const srcOrgan = typedGraph.nodes.find((n: GraphNode) => n.id === e.source)?.organ;
  const tgtOrgan = typedGraph.nodes.find((n: GraphNode) => n.id === e.target)?.organ;
  return `${organNodes.indexOf(srcOrgan!)}-${organNodes.indexOf(tgtOrgan!)}`;
}).filter((e: string) => { const [a, b] = e.split('-'); return a !== b; });
const uniqueEdges = [...new Set(organEdges)] as string[];
---

<Layout title="Architecture — Dependency Graph" description="Interactive dependency graph of the ORGANVM eight-organ system.">
    <div class="sketch-accent">
      <SketchContainer sketchId="network-graph" height="250px" mobileHeight="180px" ariaLabel="Animated network graph showing interconnected system nodes" data-nodes={organNodes.join(',')} data-edges={uniqueEdges.join(';')} />
    </div>
    <section class="section">
      <div class="container">
        <h2 class="section__heading" data-reveal>Navigate the System</h2>
        <p class="page-sub" data-reveal>Click an organ to explore its projects. Click a project to navigate there.</p>
        <ChartContainer
          chartId="organ-navigator"
          data={navigatorData}
          ariaLabel="Interactive organ navigator showing 8 organ nodes with expandable project satellites"
          height="450px"
        />
      </div>
    </section>

    <section class="section">
      <div class="container">
        <h1 class="page-title">System Architecture</h1>
        <p class="page-sub">
          {graphData.total_nodes} active repositories connected by {graphData.total_edges} dependency edges.
          Nodes are colored by organ; flagships are larger. Drag to rearrange. Hover for details.
        </p>

        <div class="legend">
          {Object.entries(organColors).map(([key, color]) => (
            <span class="legend__item">
              <span class="legend__dot" style={`background: ${color}`}></span>
              <span class="legend__label">{key}</span>
            </span>
          ))}
        </div>

        <div id="graph-container" class="graph-container" role="application" aria-label="Interactive force-directed dependency graph of ORGANVM repositories" tabindex="0">
          <noscript>Dependency graph requires JavaScript to render.</noscript>
          <div class="graph-loading">Loading dependency graph...</div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <h2 class="section__heading">Edge List</h2>
        <p class="edge-summary">{graphData.total_edges} dependency edges (no back-edges: flow is I&#8594;II&#8594;III only)</p>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Source</th>
                <th>Target</th>
              </tr>
            </thead>
            <tbody>
              {graphData.edges.map((edge: GraphEdge) => (
                <tr>
                  <td><code>{edge.source.split('/')[1]}</code></td>
                  <td><code>{edge.target.split('/')[1]}</code></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </section>
</Layout>

<script define:vars={{ graphData, organColors }}>
  async function initGraph() {
    const d3 = await import('d3');
    const container = document.getElementById('graph-container');
    if (!container) return;

    container.innerHTML = '';

    var cs = getComputedStyle(document.body);
    var borderColor = cs.getPropertyValue('--border').trim() || '#2a2a30';
    var bgColor = cs.getPropertyValue('--bg-card').trim() || '#0a0a0b';

    const width = container.clientWidth;
    const height = Math.max(500, Math.min(width * 0.6, 700));

    const svg = d3.select(container)
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', [0, 0, width, height]);

    const nodes = graphData.nodes.map((d) => ({ ...d }));
    const links = graphData.edges.map((d) => ({
      source: d.source,
      target: d.target,
    }));

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id((d) => d.id).distance(60))
      .force('charge', d3.forceManyBody().strength(-120))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius((d) => d.tier === 'flagship' ? 12 : 7));

    const link = svg.append('g')
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('stroke', borderColor)
      .attr('stroke-width', 1);

    const node = svg.append('g')
      .selectAll('circle')
      .data(nodes)
      .join('circle')
      .attr('r', (d) => d.tier === 'flagship' ? 8 : 4)
      .attr('fill', (d) => organColors[d.organ] || borderColor)
      .attr('stroke', bgColor)
      .attr('stroke-width', 1)
      .style('cursor', 'pointer');

    // Tooltip
    const tooltip = d3.select(container)
      .append('div')
      .attr('class', 'graph-tooltip')
      .style('opacity', 0);

    node.on('mouseenter', (event, d) => {
      tooltip
        .html(`<strong>${d.name}</strong><br/>${d.organ_name} (${d.organ})<br/>${d.tier} — ${d.status}`)
        .style('opacity', 1)
        .style('left', (event.offsetX + 12) + 'px')
        .style('top', (event.offsetY - 10) + 'px');
    }).on('mouseleave', () => {
      tooltip.style('opacity', 0);
    });

    // Drag
    node.call(d3.drag()
      .on('start', (event, d) => {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      })
      .on('drag', (event, d) => {
        d.fx = event.x;
        d.fy = event.y;
      })
      .on('end', (event, d) => {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      })
    );

    simulation.on('tick', () => {
      link
        .attr('x1', (d) => d.source.x)
        .attr('y1', (d) => d.source.y)
        .attr('x2', (d) => d.target.x)
        .attr('y2', (d) => d.target.y);

      node
        .attr('cx', (d) => d.x)
        .attr('cy', (d) => d.y);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGraph);
  } else {
    initGraph();
  }
</script>

<style>
  .page-sub {
    margin-bottom: var(--space-lg);
  }

  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }

  .legend__item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .legend__dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .legend__label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .graph-container {
    position: relative;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    min-height: 500px;
  }

  .graph-container :global(svg) {
    display: block;
  }

  .graph-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .graph-container :global(.graph-tooltip) {
    position: absolute;
    pointer-events: none;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.8rem;
    color: var(--text-primary);
    line-height: 1.5;
    z-index: 10;
    transition: opacity 150ms;
    max-width: 280px;
  }

  .edge-summary {
    margin-bottom: var(--space-lg);
    font-size: 0.85rem;
    color: var(--text-muted);
  }
</style>
