---
import Layout from '../../layouts/Layout.astro';
import { targets } from '../../data/targets.json';
import { personas } from '../../data/personas.json';
import { history, education, certifications } from '../../data/experience.json';
import { projectCatalogBySlug } from '../../data/project-catalog';
import { base } from '../../utils/paths';
import SketchContainer from '../../components/sketches/SketchContainer.astro';

export async function getStaticPaths() {
  return targets.map((target) => {
    const persona = personas.find(p => p.id === target.persona_id);
    return {
      params: { target: target.slug },
      props: { target, persona },
    };
  });
}

const { target, persona } = Astro.props;

// Enrich featured projects
const featuredProjects = persona.featured_projects.map(fp => {
  const catalogEntry = projectCatalogBySlug.get(fp.slug);
  return {
    ...catalogEntry,
    market_impact: fp.impact
  };
});
---

<Layout title={`Application for ${target.company} â€” Anthony James Padavano`} description={`Tailored application for ${target.role} at ${target.company}.`}>
  <div class="application-wrapper">
    
    <!-- Targeted Header -->
    <header class="target-header print-hide">
      <div class="container container--narrow">
        <div class="target-badge">Application for {target.company}</div>
        <h1 class="target-role">{target.role}</h1>
        <p class="target-intro">{target.intro}</p>
        <div class="target-actions">
          <a class="action-btn primary" href={`${base}resume/Anthony_James_Padavano_App_${target.company.replace(/\s+/g, '_')}.pdf`} download>
            Download Application Bundle
          </a>
        </div>
      </div>
    </header>

    <!-- Visual Anchor -->
    <div class="sketch-accent print-hide">
      <SketchContainer sketchId={persona.sketchId} height="120px" mobileHeight="100px" ariaLabel={`Generative visualization for ${target.company}`} />
    </div>

    <!-- The Resume Content (Identical to Persona View) -->
    <article class="market-resume">
      <div class="container container--narrow">
        
        <div class="resume-header">
          <div class="resume-header__main">
            <h2>Anthony James Padavano</h2>
            <p class="resume-header__title">{persona.title}</p>
            <p class="resume-header__subtitle">{persona.subtitle}</p>
          </div>
          
          <div class="resume-header__contact">
            <span>New York City</span>
            <span class="sep">/</span>
            <a href="mailto:padavano.anthony@gmail.com">padavano.anthony@gmail.com</a>
            <span class="sep">/</span>
            <a href="https://linkedin.com/in/anthony-james-padavano-98a40a186/" target="_blank">LinkedIn</a>
            <span class="sep">/</span>
            <a href={base}>Portfolio</a>
          </div>
        </div>

        <section class="resume-section">
          <h3 class="section-label">Professional Summary</h3>
          <div class="summary-box">
            <p class="market-summary">{persona.market_summary}</p>
            <p class="persona-thesis">{persona.thesis}</p>
          </div>
        </section>

        <section class="resume-section">
          <h3 class="section-label">Core Tech Stack</h3>
          <div class="stack-grid">
            {persona.stack.map(tech => (
              <span class="stack-tag">{tech}</span>
            ))}
          </div>
        </section>

        <section class="resume-section">
          <h3 class="section-label">Evidence of Technical Impact</h3>
          <div class="featured-projects">
            {featuredProjects.map(project => (
              <div class="resume-project">
                <div class="resume-project__header">
                  <h4>{project.title}</h4>
                  <span class="resume-project__repo">{project.sourceRepoName || project.slug}</span>
                </div>
                <p class="resume-project__impact"><strong>Impact:</strong> {project.market_impact}</p>
                <div class="resume-project__tags">
                  {project.tags.map(tag => <span class="mini-tag">{tag}</span>)}
                </div>
              </div>
            ))}
          </div>
        </section>

        <section class="resume-section">
          <h3 class="section-label">Professional History</h3>
          <div class="history-list">
            {history.map(entry => (
              <div class="history-entry">
                <div class="history-entry__header">
                  <span class="history-role">{entry.role}</span>
                  <span class="history-date">{entry.date}</span>
                </div>
                {entry.company && <p class="history-company">{entry.company}</p>}
                {entry.description ? (
                  <p class="history-desc">{entry.description}</p>
                ) : (
                  <ul class="history-highlights">
                    {entry.highlights.map(h => <li>{h}</li>)}
                  </ul>
                )}
              </div>
            ))}
          </div>
        </section>

        <div class="resume-grid-two-col">
          <section class="resume-section">
            <h3 class="section-label">Education</h3>
            {education.map(edu => (
              <div class="edu-entry">
                <strong>{edu.degree}</strong>
                <span>{edu.institution}</span>
                <span class="edu-date">{edu.date}</span>
              </div>
            ))}
          </section>

          <section class="resume-section">
            <h3 class="section-label">Certifications</h3>
            <ul class="cert-list">
              {certifications.map(cert => (
                <li><strong>{cert.issuer}</strong> {cert.name} <span class="cert-date">({cert.date})</span></li>
              ))}
            </ul>
          </section>
        </div>

      </div>
    </article>
  </div>
</Layout>

<style>
  .target-header {
    background: var(--bg-secondary);
    padding: var(--space-2xl) 0;
    margin-bottom: var(--space-xl);
    border-bottom: 1px solid var(--border);
  }

  .target-badge {
    display: inline-block;
    background: var(--accent);
    color: var(--bg-primary);
    padding: 0.2rem 0.8rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-md);
  }

  .target-role {
    font-size: 2rem;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
  }

  .target-intro {
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 65ch;
    margin-bottom: var(--space-lg);
    line-height: 1.6;
    border-left: 3px solid var(--accent-text);
    padding-left: var(--space-md);
  }

  .target-actions {
    display: flex;
    gap: var(--space-md);
  }

  .action-btn.primary {
    background: var(--accent-text);
    color: var(--bg-primary);
    padding: var(--space-xs) var(--space-lg);
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-weight: 600;
    transition: all var(--transition-fast);
  }

  .action-btn.primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  /* Reuse resume styles */
  .market-resume {
    padding-bottom: var(--space-3xl);
    color: var(--text-primary);
  }

  .resume-header {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--border);
  }

  .resume-header__title {
    font-size: 1.5rem;
    color: var(--accent-text);
    margin-bottom: var(--space-2xs);
  }

  .resume-header__subtitle {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .resume-header__contact {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .resume-header__contact a {
    color: var(--text-primary);
    text-decoration: none;
  }

  .resume-header__contact .sep {
    color: var(--border);
  }

  .resume-section {
    margin-bottom: var(--space-2xl);
  }

  .section-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--accent);
    margin-bottom: var(--space-lg);
    border-left: 3px solid var(--accent);
    padding-left: var(--space-sm);
  }

  .summary-box {
    background: var(--bg-secondary);
    padding: var(--space-lg);
    border-radius: var(--radius);
  }

  .market-summary {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    line-height: 1.4;
  }

  .persona-thesis {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .stack-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .stack-tag {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-primary);
  }

  .featured-projects {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .resume-project {
    background: var(--bg-card);
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .resume-project__header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: var(--space-sm);
  }

  .resume-project__repo {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .resume-project__impact {
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: var(--space-md);
  }

  .mini-tag {
    font-size: 0.65rem;
    text-transform: uppercase;
    background: var(--bg-secondary);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    margin-right: 4px;
    color: var(--text-muted);
  }

  .history-entry {
    margin-bottom: var(--space-xl);
  }

  .history-entry__header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-2xs);
  }

  .history-role {
    font-weight: 700;
    color: var(--text-primary);
  }

  .history-date {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .history-company {
    font-size: 0.9rem;
    color: var(--accent-text);
    margin-bottom: var(--space-sm);
  }

  .history-highlights {
    padding-left: var(--space-lg);
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .history-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .resume-grid-two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-2xl);
  }

  .edu-entry {
    display: flex;
    flex-direction: column;
    margin-bottom: var(--space-md);
    font-size: 0.9rem;
  }

  .edu-date {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .cert-list {
    list-style: none;
    font-size: 0.85rem;
  }

  .cert-list li {
    margin-bottom: var(--space-xs);
  }

  .cert-date {
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .resume-grid-two-col {
      grid-template-columns: 1fr;
    }
    
    .history-entry__header {
      flex-direction: column;
    }
  }

  /* Print specific overrides */
  @media print {
    .target-header, .sketch-accent {
      display: none !important;
    }
    
    .market-resume {
      padding: 0;
    }
    
    .resume-header {
      border-bottom: 2px solid #333;
    }

    .resume-project, .summary-box {
      background: #fafafa !important;
      border: 1px solid #eee !important;
      page-break-inside: avoid;
    }

    .section-label {
      border-left: 4px solid #333 !important;
      color: #111 !important;
    }

    .history-entry {
      page-break-inside: avoid;
    }
  }
</style>
